<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grid Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Emerald Green */
                        'secondary': '#f97316', /* Orange */
                        'text-dark': '#1f2937',
                        'bg-light': '#ffffff',
                        'bus-good': '#10b981',
                        'bus-low': '#fbbf24',
                        'bus-crit': '#ef4444',
                        'bus-fault': '#dc2626',
                        'bus-default': '#6b7280', /* Gray for unanalyzed state */
                        'code-pass': '#10b981',
                        'code-fail': '#dc2626',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6; /* Light background */
            color: #1f2937; /* Dark text */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Tables */
        .bus-result-table th, .bus-result-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #d1d5db;
            font-size: 0.875rem;
        }
        .bus-result-table th {
            background-color: #e5e7eb;
            color: #4b5563;
            font-weight: 600;
        }
        .short-circuit-table th, .short-circuit-table td, .compliance-table th, .compliance-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #d1d5db;
            font-size: 0.875rem;
        }
        .short-circuit-table td:nth-child(2) {
            font-weight: 700;
            color: #f97316; /* Secondary color for results */
        }
        /* Configuration Inputs */
        .config-input {
            width: 100%; /* Default width changed to 100% for better layout in grid */
            padding: 2px 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: right;
            font-size: 0.75rem;
            color: #1f2937;
        }
        .config-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px; /* For scrollbar padding */
        }
        /* Adjusted grid for line configuration to fit new dropdowns and inputs */
        .line-item {
            display: grid;
            grid-template-columns: 1.2fr 0.5fr 0.5fr 0.7fr 0.7fr 0.3fr;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.75rem; /* Reduced font size to fit more elements */
        }
        /* New line config layout for breakers/reclosers */
        .line-item-full {
             display: grid;
            grid-template-columns: 1.2fr 0.5fr 0.5fr 0.7fr 0.7fr 0.7fr 0.7fr 0.3fr; /* 8 columns */
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.75rem;
        }
        .line-item > span {
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }
        /* Style for the new select dropdown */
        .line-select {
            padding: 2px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #1f2937;
            background-color: white;
            width: 100%;
        }

        /* SVG Styling */
        #networkSVG {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background-color: #ffffff;
            width: 100%;
            height: 400px;
        }
        /* Small input fix in table */
        .bus-result-table .config-input {
            width: 70px; /* Make inputs in the table smaller */
            padding: 1px 3px;
        }
        /* Iterative Table Styling */
        .iterative-table th, .iterative-table td {
            padding: 6px;
            font-size: 0.75rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .iterative-table th {
            background-color: #f3f4f6;
        }
        /* Bubbly Button Style */
        .bubbly-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .bubbly-button:hover {
            transform: scale(1.01);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-text-dark mb-6 border-b-2 border-primary pb-2 text-center flex items-center justify-center">
            <!-- Icon for Smart Grid Simulator -->
            <svg class="w-8 h-8 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            Smart Grid Simulator
        </h1>

        <!-- System Visualization and Configuration -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

            <!-- Network Topology Diagram (SVG) -->
            <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-xl">
                <h2 class="text-xl font-semibold text-text-dark mb-4">Network Topology & Voltage Status </h2>
                <div id="svgContainer">
                     <svg id="networkSVG"></svg>
                </div>
                <p id="faultBusTip" class="mt-4 text-center text-sm text-gray-500">Click a bus node in the diagram to select the fault location. Current Fault Bus: <span id="currentFaultBus" class="font-bold text-red-600">10</span></p>
            </div>

            <!-- Line Configuration -->
            <div class="bg-white p-5 rounded-xl shadow-xl">
                <h2 class="text-xl font-semibold text-text-dark mb-4 border-b border-gray-300 pb-2">Line Configuration & Protection (32 Lines)</h2>
                <div id="lineConfigHeader" class="text-xs text-gray-500 grid grid-cols-8 gap-2 font-bold mb-1 px-1">
                    <span>Wire Type</span>
                    <span>From</span>
                    <span>To</span>
                    <span class="text-right">R (p.u.)</span>
                    <span class="text-right">X (p.u.)</span>
                    <span>Breaker</span>
                    <span>Recloser</span>
                    <span>On/Off</span>
                </div>
                <div id="lineConfiguration" class="config-list">
                    <!-- Line toggles, R/X, Breaker/Recloser inputs will be inserted here -->
                </div>
                <button onclick="runLoadFlow()" class="bubbly-button mt-4 w-full py-2 px-4 bg-gradient-to-r from-primary to-teal-500 text-white font-bold rounded-xl hover:bg-teal-700 transition duration-300 shadow-lg">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0h6m-6 0h-2m8 0V7a2 2 0 00-2-2h-2a2 2 0 00-2 2v12m-2-12h4m2 0V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v12m-2-12h4"></path></svg>
                    Apply Changes & Run Load Flow
                </button>
            </div>
        </div>

        <!-- Controls Panel (Load/Gen Editing) -->
        <div class="bg-white p-5 rounded-xl shadow-xl mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <h2 class="text-xl font-semibold text-text-dark mb-4 border-b border-gray-300 pb-2">Bus Parameter & Smart Grid Editing</h2>
                <div id="busParameterEditing" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Dynamic editing inputs inserted here -->
                </div>
            </div>
            <div class="md:col-span-1 border-l border-gray-300 pl-4">
                <h2 class="text-xl font-semibold text-text-dark mb-4 border-b border-gray-300 pb-2">Analysis Tools</h2>
                <div class="space-y-2">
                    <select id="loadFlowMethod" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300 text-text-dark focus:ring-primary focus:border-primary">
                        <option value="NR">Newton-Raphson (NR)</option>
                        <option value="GS">Gauss-Seidel (GS)</option>
                    </select>
                    <div class="flex items-center space-x-2">
                        <select id="faultType" class="flex-1 p-2 rounded-lg bg-gray-100 border border-gray-300 text-text-dark focus:ring-secondary focus:border-secondary">
                            <option value="LLL">Three-Phase (L-L-L) Fault</option>
                            <option value="SLG">Single-Line-to-Ground (SLG) Fault</option>
                            <option value="LL">Line-to-Line (L-L) Fault</option>
                            <option value="LLG">Double-Line-to-Ground (L-L-G) Fault</option>
                        </select>
                        <input type="number" id="faultBus" min="1" max="15" value="10" placeholder="Bus" class="w-16 p-2 rounded-lg bg-gray-100 border border-gray-300 text-text-dark text-center" onchange="selectFaultBus(parseInt(this.value))">
                    </div>
                    <button onclick="runShortCircuit()" class="bubbly-button w-full py-2 px-4 bg-gradient-to-r from-secondary to-orange-400 text-white font-bold rounded-xl hover:bg-orange-600 transition duration-300 shadow-lg">
                        <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Run Short Circuit Analysis
                    </button>
                </div>
            </div>
        </div>


        <!-- Results Display Tabs -->
        <div class="bg-white p-5 rounded-xl shadow-md">
            <div class="flex border-b border-gray-300 overflow-x-auto">
                <button id="tabLF" onclick="showResults('loadFlow')" class="flex-shrink-0 px-4 py-2 text-lg font-semibold border-b-2 border-primary text-primary transition duration-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l2-2m0 0l2 2m-2-2V5m7 7h-6m6 0l-2 2m0 0l2 2m-2-2v5"></path></svg>
                    Summary Load Flow
                </button>
                <button id="tabLFIterative" onclick="showResults('loadFlowIterative')" class="flex-shrink-0 px-4 py-2 text-lg font-semibold text-gray-500 hover:text-text-dark transition duration-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Iterative Load Flow
                </button>
                <button id="tabSC" onclick="showResults('shortCircuit')" class="flex-shrink-0 px-4 py-2 text-lg font-semibold text-gray-500 hover:text-text-dark transition duration-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Short Circuit Results
                </button>
                 <button id="tabCompliance" onclick="showResults('compliance')" class="flex-shrink-0 px-4 py-2 text-lg font-semibold text-gray-500 hover:text-text-dark transition duration-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.048A12.007 12.007 0 002.944 12c.045 4.316 2.054 8.243 5.395 10.982.352.288.75.524 1.182.721 1.258.571 2.667.854 4.079.853a12.004 12.004 0 004.081-.853c.432-.197.83-.433 1.182-.721 3.34-2.739 5.35-6.666 5.395-10.982.028-2.61.16-5.183.385-7.69"></path></svg>
                    Code Compliance & Sizing
                </button>
            </div>
            
            <!-- Load Flow Summary -->
            <div id="loadFlowResults" class="mt-4 overflow-x-auto h-[450px]">
                <!-- Dedicated message area -->
                <div id="lfMessage" class="text-gray-500 text-center py-10">
                    Run the Load Flow Analysis to view voltage magnitudes and angles across the system.
                    <p class="mt-4 text-xs text-gray-400">P Load/Gen and V Setpoint in the table below are editable for buses other than the Slack bus (Bus 1).</p>
                </div>
                <table id="lfTable" class="min-w-full bus-result-table hidden"></table>
            </div>

            <!-- Load Flow Iterative -->
            <div id="loadFlowIterativeResults" class="mt-4 overflow-x-auto h-[450px] hidden">
                 <div id="lfIterativeMessage" class="text-gray-500 text-center py-10">
                    The step-by-step convergence data will appear here after running the Load Flow Analysis.
                </div>
            </div>

            <!-- Short Circuit Results -->
            <div id="shortCircuitResults" class="mt-4 hidden h-[450px]">
                <p class="text-gray-500 text-center py-10">Run the Short Circuit Analysis after a Load Flow to view fault current and MVA.</p>
                <table class="min-w-full text-sm short-circuit-table">
                    <thead>
                        <tr>
                            <th class="w-1/2">Parameter</th>
                            <th class="w-1/2">Value</th>
                        </tr>
                    </thead>
                    <tbody id="scBody">
                        <!-- SC Results will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Code Compliance & Smart Grid Optimization Results -->
             <div id="complianceResults" class="mt-4 hidden h-[450px] overflow-y-auto">
                <p id="complianceMessage" class="text-gray-500 text-center py-10">
                    Run the Load Flow to calculate system metrics against the Philippine Electrical Code (PEC) and Grid Code (PGC) simplified standards.
                </p>
                <div id="complianceBody" class="space-y-6">
                    <!-- Compliance and Sizing Tables will be injected here -->
                </div>

                <!-- Optimization & Action Section -->
                <div id="optimizationSection" class="mt-8 p-4 bg-white border border-gray-200 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-lg font-bold text-text-dark flex items-center">
                            <svg class="w-5 h-5 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.048A12.007 12.007 0 002.944 12c.045 4.316 2.054 8.243 5.395 10.982.352.288.75.524 1.182.721 1.258.571 2.667.854 4.079.853a12.004 12.004 0 004.081-.853c.432-.197.83-.433 1.182-.721 3.34-2.739 5.35-6.666 5.395-10.982.028-2.61.16-5.183.385-7.69"></path></svg>
                            Optimization & Action
                        </h3>
                         <button onclick="optimizeViolations()" id="optimizeButton" class="bubbly-button py-2 px-4 bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold rounded-xl hover:from-orange-600 transition duration-300 shadow-md flex items-center disabled:opacity-50">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Optimize Violations & Re-Run
                        </button>
                    </div>
                    <p id="optimizationText" class="text-gray-700 text-sm"></p>
                </div>
            </div>

        </div>

    </div>

    <script>
        // Global Constants
        const BASE_MVA = 100.0;
        const BASE_KV_LINE = 13.8;
        const NUM_BUSES = 15;
        const NUM_LINES = 32;

        // PEC/PGC (Simplified) Constants
        const MAX_VOLTAGE_DROP_PERCENT = 3.0; // PEC (based on 3% feeder/branch drop)
        const FREQUENCY_LIMIT_MIN = 0.9995; // PGC Frequency tolerance (simulated)
        const VOLTAGE_LIMIT_MIN = 0.95; // PGC Voltage tolerance (simulated, tighter than standard 0.9 p.u.)
        const BREAKER_SAFETY_MARGIN = 1.25; // PEC 125% continuous load rule (simplified)
        const RECLOSER_MODELS = ['Single-Phase', 'Three-Phase', 'Substation'];
        const BREAKER_MODELS = ['OCB', 'SF6', 'Vacuum'];


        // ACSR data (Ampacity added for sizing)
        const ACSR_TYPES = [
            { name: "TURKEY (6 AWG)", R_DC: 2.1499, X_R_ratio: 3.5, code: "TURKEY", ampacity: 40 },
            { name: "THRUSH (5 AWG)", R_DC: 1.6987, X_R_ratio: 4.0, code: "THRUSH", ampacity: 55 },
            { name: "SWAN (4 AWG)", R_DC: 1.3501, X_R_ratio: 4.5, code: "SWAN", ampacity: 70 },
            { name: "SWALLOW (3 AWG)", R_DC: 1.0712, X_R_ratio: 5.0, code: "SWALLOW", ampacity: 80 },
            { name: "SPARROW (2 AWG)", R_DC: 0.8512, X_R_ratio: 5.5, code: "SPARROW", ampacity: 95 },
            { name: "ROBIN (1 AWG)", R_DC: 0.6742, X_R_ratio: 7, code: "ROBIN", ampacity: 110 },
            { name: "RAVEN (1/0 AWG)", R_DC: 0.5343, X_R_ratio: 7.5, code: "RAVEN", ampacity: 125 },
            { name: "QUAIL (2/0 AWG)", R_DC: 0.4247, X_R_ratio: 8, code: "QUAIL", ampacity: 145 },
            { name: "PIGEON (3/0 AWG)", R_DC: 0.3359, X_R_ratio: 9, code: "PIGEON", ampacity: 165 },
            { name: "PENGUIN (4/0 AWG)", R_DC: 0.2667, X_R_ratio: 10, code: "PENGUIN", ampacity: 195 },
            { name: "OWL (266.8 MCM)", R_DC: 0.2112, X_R_ratio: 11, code: "OWL", ampacity: 230 },
            { name: "MERLIN (336.4 MCM)", R_DC: 0.1688, X_R_ratio: 12, code: "MERLIN", ampacity: 260 },
            { name: "CHICKADEE (397.7 MCM)", R_DC: 0.1430, X_R_ratio: 13, code: "CHICKADEE", ampacity: 280 },
            { name: "PELICAN (477 MCM)", R_DC: 0.1186, X_R_ratio: 14, code: "PELICAN", ampacity: 310 },
            { name: "OSPREY (556.5 MCM)", R_DC: 0.1017, X_R_ratio: 15, code: "OSPREY", ampacity: 335 },
            { name: "CARDINAL (954 MCM)", R_DC: 0.0596, X_R_ratio: 20, code: "CARDINAL", ampacity: 415 },
            { name: "LAPWING (1590 MCM)", R_DC: 0.0359, X_R_ratio: 24, code: "LAPWING", ampacity: 450 },
            // Simplified British/DIN set for variety
            { name: "SQUIRREL (20 mm²)", R_DC: 1.3700, X_R_ratio: 4.5, code: "SQUIRREL", ampacity: 50 },
            { name: "RABBIT (50 mm²)", R_DC: 0.5426, X_R_ratio: 8.0, code: "RABBIT", ampacity: 90 },
            { name: "WOLF (150 mm²)", R_DC: 0.1828, X_R_ratio: 14, code: "WOLF", ampacity: 180 },
            { name: "DEER (400 mm²)", R_DC: 0.0673, X_R_ratio: 22, code: "DEER", ampacity: 320 },
            { name: "DIN 550/70", R_DC: 0.0526, X_R_ratio: 25, code: "DIN550", ampacity: 400 },
        ];
        
        // System Data Storage
        let busData = [];
        let lineData = [];
        let lfResults = null;
        let lfIterativeData = [];
        let selectedFaultBus = 10;
        let busCoordinates = [];

        // --- Core Simulation Functions ---

        /**
         * Runs Load Flow and updates display.
         */
        function runLoadFlow() {
            const method = document.getElementById('loadFlowMethod').value;
            const lfMessage = document.getElementById('lfMessage');
            const lfIterativeMessage = document.getElementById('lfIterativeMessage');
            const table = document.getElementById('lfTable');
            const complianceMessage = document.getElementById('complianceMessage');

            // 1. Hide tables and display the loading spinner in the message area
            table.classList.add('hidden');
            lfMessage.classList.remove('hidden');
            lfIterativeMessage.innerHTML = `<p class="text-center text-primary py-10 flex items-center justify-center font-semibold">
                                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Running ${method} Load Flow Analysis (Simulated Iterations)...
                                        </p>`;
            complianceMessage.textContent = 'Calculating PEC/PGC compliance and sizing metrics...';
            document.getElementById('optimizeButton').disabled = true; // Disable button while running


            setTimeout(() => {
                const results = loadFlow(method);
                displayLoadFlowResults(results, method);
                displayIterativeResults();
                displayNetworkTopology(results);
                runCodeComplianceAndSizing(results); // Run compliance check immediately after LF
                showResults('loadFlow');
            }, 1500);
        }

        /**
         * Simulates the Load Flow process using user-defined parameters and active lines.
         */
        function loadFlow(method) {
            lfIterativeData = []; 
            const activeLines = lineData.filter(line => line.active);
            
            const totalZ_active = activeLines.reduce((sum, line) => sum + line.Z_pu, 0);
            const systemImpedanceFactor = totalZ_active > 0 ? totalZ_active / NUM_LINES : 1.0; 

            const MAX_ITERATIONS = (method === 'NR') ? 4 : 8;
            
            let V_current = busData.map(b => b.V_result);
            let delta_current = busData.map(b => b.delta);

            // Apply Smart Grid actions and calculate initial P/Q loads/gens
            busData.forEach((bus, i) => {
                // Apply DG contribution
                if (bus.DG_status === 'On') {
                    bus.P_gen = bus.DG_capacity;
                    // Apply Smart Inverter Q control (DG_Q_mode)
                    if (bus.DG_Q_mode === 'Boost V') {
                        bus.Q_gen = bus.DG_capacity * 0.2; // Inject Q
                    } else if (bus.DG_Q_mode === 'Absorb Q') {
                        bus.Q_gen = -bus.DG_capacity * 0.1; // Absorb Q
                    } else {
                        bus.Q_gen = 0.0;
                    }

                } else if (bus.DG_status === 'Off') {
                    bus.P_gen = 0.0;
                    bus.Q_gen = 0.0;
                }
                
                // Apply Demand Response (Load Reduction)
                if (bus.DR_enabled && bus.DR_reduction > 0) {
                    const maxReduction = bus.P_load_base * 0.5;
                    const reduction = Math.min(bus.DR_reduction, maxReduction);
                    bus.P_load = bus.P_load_base - reduction;
                    bus.Q_load = bus.Q_load_base - (reduction * 0.5); 
                } else {
                    bus.P_load = bus.P_load_base;
                    bus.Q_load = bus.Q_load_base;
                }
            });
            
            let P_bus_base = busData.map(b => b.P_load - b.P_gen);
            let Q_bus_base = busData.map(b => b.Q_load - b.Q_gen);

            // Save initial values (Iteration 0)
            lfIterativeData.push({
                iteration: 0,
                method: method,
                data: busData.map(b => ({
                    id: b.id,
                    V: b.V_result,
                    delta: b.delta,
                }))
            });

            for (let k = 1; k <= MAX_ITERATIONS; k++) {
                let V_next = [...V_current];
                let delta_next = [...delta_current];
                
                busData.forEach((bus, i) => {
                    if (bus.type === 'Slack') {
                        V_next[i] = 1.000;
                        delta_next[i] = 0.00;
                        return;
                    }
                    
                    const P_mismatch = P_bus_base[i] + bus.P_gen - 1.0; 
                    const Q_mismatch = Q_bus_base[i] - bus.Q_gen;

                    let correctionFactor = (method === 'NR') ? 0.3 : 0.15;
                    correctionFactor *= (MAX_ITERATIONS - k + 1) / MAX_ITERATIONS; 
                    
                    let dV = -(P_mismatch * 0.05 + Q_mismatch * 0.01) * correctionFactor;
                    let dDelta = -(P_mismatch * 0.02 - Q_mismatch * 0.03) * correctionFactor * 10;
                    
                    if (bus.type === 'PV') {
                         V_next[i] = bus.V; 
                         delta_next[i] = delta_current[i] + dDelta;
                    } else { // PQ
                         V_next[i] = V_current[i] + dV;
                         delta_next[i] = delta_current[i] + dDelta;
                    }
                    
                    V_next[i] = parseFloat(Math.max(0.80, Math.min(1.05, V_next[i])).toFixed(4));
                    delta_next[i] = parseFloat(delta_next[i].toFixed(4));
                });
                
                V_current = V_next;
                delta_current = delta_next;

                lfIterativeData.push({
                    iteration: k,
                    method: method,
                    data: busData.map((b, i) => ({
                        id: b.id,
                        V: V_current[i],
                        delta: delta_current[i]
                    }))
                });
            }

            // Final results update & Voltage Drop Calculation
            busData.forEach((bus, i) => {
                bus.V_result = V_current[i];
                bus.delta = delta_current[i];
                
                // Calculate Voltage Drop % (relative to 1.0 p.u. slack bus)
                bus.voltage_drop_percent = parseFloat(((1.0 - bus.V_result) * 100).toFixed(2));
            });

            lfResults = busData.map(bus => ({
                id: bus.id,
                V: bus.V_result,
                delta: bus.delta,
                voltage_drop_percent: bus.voltage_drop_percent
            }));

            return lfResults;
        }

        /**
         * Simulates Short Circuit Analysis (simplified).
         */
        function shortCircuit(faultBusId, faultType) {
            const busIndex = faultBusId - 1;
            const V_pre_fault = lfResults ? lfResults[busIndex].V : busData[busIndex].V_result;
            
            const activeLines = lineData.filter(line => line.active);
            const totalZ_active = activeLines.reduce((sum, line) => sum + line.Z_pu, 0);

            const baseZ1 = totalZ_active / (NUM_LINES * 2) + 0.01; 
            const Z1 = baseZ1 * (1 + (busIndex / NUM_BUSES) * 0.5); 
            const Z2 = Z1 * 1.05;
            const Z0 = Z1 * 2.5; 

            let I1_pu, I2_pu, I0_pu; 
            const V_base = 1.0; 

            switch (faultType) {
                case 'LLL': 
                    I1_pu = V_base / Z1; I2_pu = 0.0; I0_pu = 0.0; break;
                case 'SLG': 
                    I1_pu = V_base / (Z1 + Z2 + Z0); I2_pu = I1_pu; I0_pu = I1_pu; break;
                case 'LL': 
                    I1_pu = V_base / (Z1 + Z2); I2_pu = -I1_pu; I0_pu = 0.0; break;
                case 'LLG': 
                    const Z_parallel = (Z2 * Z0) / (Z2 + Z0);
                    I1_pu = V_base / (Z1 + Z_parallel);
                    I0_pu = -I1_pu * (Z2 / (Z2 + Z0));
                    I2_pu = -I1_pu * (Z0 / (Z2 + Z0)); break;
            }
            
            let I_fault_pu;
            if (faultType === 'LLL') {
                I_fault_pu = I1_pu;
            } else if (faultType === 'SLG') {
                I_fault_pu = 3 * I0_pu;
            } else if (faultType === 'LL') {
                I_fault_pu = Math.sqrt(3) * I1_pu;
            } else { // LLG
                I_fault_pu = Math.abs(I1_pu) + Math.abs(I2_pu) + Math.abs(I0_pu); 
            }
            
            const I_base_A = (BASE_MVA * 1000) / (Math.sqrt(3) * BASE_KV_LINE);
            const I_fault_A = I_fault_pu * I_base_A;
            const MVA_sc = I_fault_pu * BASE_MVA;

            return {
                busId: faultBusId,
                faultType: faultType,
                I_fault_A: Math.round(I_fault_A).toLocaleString() + ' Amperes',
                MVA_sc: MVA_sc.toFixed(2) + ' MVA',
                I_sc_pu: I_fault_pu.toFixed(4)
            };
        }


        /**
         * Runs Short Circuit analysis and updates display.
         */
        function runShortCircuit() {
            const inputBus = parseInt(document.getElementById('faultBus').value);
            const faultType = document.getElementById('faultType').value;
            const faultBusId = inputBus;
            const scBody = document.getElementById('scBody');
            scBody.innerHTML = '';
            showResults('shortCircuit');
            selectFaultBus(faultBusId); 

            if (faultBusId < 1 || faultBusId > 15 || isNaN(faultBusId)) {
                scBody.innerHTML = `<tr><td colspan="2" class="text-center text-red-600 py-4">Invalid bus ID. Please select a bus between 1 and 15.</td></tr>`;
                return;
            }

            scBody.innerHTML = `<tr><td colspan="2" class="text-center text-secondary py-4 flex items-center justify-center font-semibold">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Running **${faultType}** Short Circuit Analysis...
                                </td></tr>`;

            setTimeout(() => {
                const results = shortCircuit(faultBusId, faultType);
                displayShortCircuitResults(results);
            }, 1000);
        }


        /**
         * Simulates Wire Sizing, Breaker Sizing, and Code Compliance Checks. (New Function)
         */
        function runCodeComplianceAndSizing(lfResults) {
            const complianceBody = document.getElementById('complianceBody');
            const optimizationText = document.getElementById('optimizationText');
            const optimizationButton = document.getElementById('optimizeButton');
            complianceBody.innerHTML = '';
            
            const I_base_A = (BASE_MVA * 1000) / (Math.sqrt(3) * BASE_KV_LINE);
            let optimizationNeeded = false;
            let codeViolationsCount = 0;
            let V_violation_buses = []; // To track which buses violated V limits

            // --- 1. Bus-Level Compliance (PGC Voltage) ---
            let complianceTableHTML = `
                <h3 class="text-xl font-semibold text-text-dark mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    Bus Compliance (PGC Voltage & PEC Drop)
                </h3>
                <table class="min-w-full compliance-table">
                    <thead>
                        <tr class="bg-gray-200">
                            <th>Bus ID</th>
                            <th>V Mag. (p.u.)</th>
                            <th>PGC Voltage Limit (0.95 p.u.)</th>
                            <th>PEC V Drop (<3%)</th>
                            <th>Load Current (I<sub class="text-xs">L</sub>) (A)</th>
                            <th>Rec. Breaker (A)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            lfResults.forEach(res => {
                const bus = busData.find(b => b.id === res.id);
                const V_drop_percent = bus.voltage_drop_percent;
                const V_mag = res.V;

                // PGC Voltage Compliance (Simulated based on V > 0.95 p.u. - PGC Sec. 6.3.1.2)
                const isPGC_V_OK = V_mag >= VOLTAGE_LIMIT_MIN; 
                // PEC Voltage Drop Compliance (Simulated based on VD < 3% - PEC 2.30.2.7)
                const isPEC_VD_OK = V_drop_percent <= MAX_VOLTAGE_DROP_PERCENT;
                
                if (!isPGC_V_OK || !isPEC_VD_OK) { 
                    codeViolationsCount++; 
                    optimizationNeeded = true; 
                    V_violation_buses.push(bus.id);
                }

                // Load Current & Breaker Sizing (PEC 2.15.2.2: OCPD @ 125% continuous load)
                const S_load_pu = Math.sqrt(bus.P_load_base * bus.P_load_base + bus.Q_load_base * bus.Q_load_base);
                const I_load_A = (S_load_pu / res.V) * I_base_A;
                const requiredBreakerRating = Math.ceil((I_load_A * BREAKER_SAFETY_MARGIN) / 10) * 10;
                
                complianceTableHTML += `
                    <tr>
                        <td>${bus.id}</td>
                        <td>${V_mag.toFixed(4)}</td>
                        <td class="${isPGC_V_OK ? 'text-code-pass' : 'text-code-fail font-bold'}">
                            ${isPGC_V_OK ? 'PASS (PGC 6.3.1.2)' : 'FAIL (Low V)'}
                        </td>
                        <td class="${isPEC_VD_OK ? 'text-code-pass' : 'text-code-fail font-bold'}">
                            ${isPEC_VD_OK ? 'PASS' : `FAIL (${V_drop_percent.toFixed(2)}%)`}
                        </td>
                        <td>${I_load_A.toFixed(1)}</td>
                        <td>${requiredBreakerRating} A</td>
                    </tr>
                `;
            });

            complianceTableHTML += `</tbody></table>`;
            complianceBody.innerHTML += complianceTableHTML;
            
            
            // --- 2. Line-Level Compliance (PEC Wire Sizing) ---
            let wireSizingHTML = `
                <h3 class="text-xl font-semibold text-text-dark mb-3 flex items-center mt-6">
                    <svg class="w-5 h-5 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.477 3-10S13.657 3 12 3s-3 4.477-3 10 1.343 10 3 10z"></path></svg>
                    Line Sizing & Protection Compliance (PEC 3.10.1.5 - Ampacity)
                </h3>
                <table class="min-w-full compliance-table text-xs">
                    <thead>
                        <tr class="bg-gray-200">
                            <th>Line (From-To)</th>
                            <th>Wire Type</th>
                            <th>OCPD Model</th>
                            <th>Line Current (A)</th>
                            <th>Ampacity (A)</th>
                            <th>Compliance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Note: Line Current is still a simplified proxy calculation
            lineData.forEach(line => {
                const currentACSR = ACSR_TYPES.find(t => t.code === line.wireType);
                if (!currentACSR) return; 

                const lineCurrentA = (busData.find(b => b.id === line.from).P_load * I_base_A) / BASE_MVA / line.from;
                const requiredAmpacity = lineCurrentA * BREAKER_SAFETY_MARGIN; 
                
                const isWireAdequate = currentACSR.ampacity >= requiredAmpacity;
                
                if (!isWireAdequate) { codeViolationsCount++; optimizationNeeded = true; }
                
                // Find recommended upgrade
                const recommendedWire = ACSR_TYPES.find(t => t.ampacity >= requiredAmpacity) || ACSR_TYPES[ACSR_TYPES.length - 1]; 

                line.isWireAdequate = isWireAdequate;
                line.recommendedWire = recommendedWire.code;
                line.requiredAmpacity = requiredAmpacity;
                
                wireSizingHTML += `
                    <tr>
                        <td>${line.from}-${line.to}</td>
                        <td>${currentACSR.name}</td>
                        <td>${line.breakerModel} / ${line.recloserModel}</td>
                        <td>${lineCurrentA.toFixed(1)}</td>
                        <td>${currentACSR.ampacity}</td>
                        <td class="${isWireAdequate ? 'text-code-pass' : 'text-code-fail font-bold'}">
                            ${isWireAdequate ? 'PASS' : `FAIL (Rec: ${recommendedWire.code})`}
                        </td>
                    </tr>
                `;
            });
            
            wireSizingHTML += `</tbody></table>`;
            complianceBody.innerHTML += wireSizingHTML;
            
            
            // --- 3. Optimization Recommendation ---
            let optimizationMessage = `**SUMMARY:** ${codeViolationsCount} total potential code violation(s) detected (PGC V, PEC VD, PEC Ampacity). Use the 'Optimize Violations' button for automatic corrective actions.`;
            
            if (codeViolationsCount === 0) {
                 optimizationMessage = `**SYSTEM STATUS: GREEN.** All system metrics pass simplified PGC/PEC compliance checks. System is highly resilient.`;
                 optimizationButton.disabled = true;
                 optimizationButton.classList.remove('from-orange-500', 'to-red-500');
                 optimizationButton.classList.add('from-gray-400', 'to-gray-500');
                 optimizationButton.textContent = 'No Violations to Optimize';
            } else {
                 optimizationButton.disabled = false;
                 optimizationButton.classList.add('from-orange-500', 'to-red-500');
                 optimizationButton.classList.remove('from-gray-400', 'to-gray-500');
                 optimizationButton.textContent = 'Optimize Violations & Re-Run';
            }

            optimizationText.textContent = optimizationMessage;
            document.getElementById('complianceMessage').classList.add('hidden');
        }

        /**
         * Attempts to fix all detected PEC/PGC violations by adjusting system parameters (wire size, DG/DR).
         */
        function optimizeViolations() {
            // 1. Apply Smart Grid Actions (If V is violated)
            if (busData.some(bus => bus.voltage_drop_percent > MAX_VOLTAGE_DROP_PERCENT || bus.V_result < VOLTAGE_LIMIT_MIN)) {
                
                // Activate DG on available buses
                busData.filter(b => b.DG_capacity > 0 && b.DG_status === 'Off').forEach(bus => {
                    bus.DG_status = 'On';
                    // Enable Q boost if V is low
                    if (bus.V_result < 0.96) {
                         bus.DG_Q_mode = 'Boost V';
                    }
                });

                // Apply maximum DR reduction to enabled buses
                 busData.filter(b => b.DR_enabled).forEach(bus => {
                    bus.DR_reduction = bus.P_load_base * 0.5;
                });
            }

            // 2. Apply PEC Ampacity Fixes (Wire Sizing)
            lineData.forEach(line => {
                if (!line.isWireAdequate && line.recommendedWire) {
                    // Update wire type to the recommended size
                    line.wireType = line.recommendedWire;
                    // Recalculate R/X based on the new wire type
                    recalculateLineImpedance(line.id, line.recommendedWire);
                }
                
                // Default Breaker/Recloser selection for new wires/simplicity
                if (!line.breakerModel || line.breakerModel === 'N/A') {
                    line.breakerModel = 'SF6';
                    line.recloserModel = 'Three-Phase';
                }
            });

            // 3. Update UI and Re-run Load Flow
            displayLineConfiguration(); // Reflect new wire/protection settings
            displayBusEditing(); // Reflect new DG/DR status
            runLoadFlow(); // Re-run analysis to check compliance after optimization
        }


        // --- Data Initialization and UI Helpers ---

        /**
         * Initializes the 15-Bus system data, including Smart Grid features.
         */
        function initializeSystemData() {
            busData = [];
            lineData = [];
            busCoordinates = [];
            
            // 1. Bus Data Initialization
            for (let i = 1; i <= NUM_BUSES; i++) {
                let type = 'PQ';
                let Pgen = 0.0;
                let V_init = 1.0;

                if (i === 1) {
                    type = 'Slack';
                    V_init = 1.000;
                } else if (i === 2) {
                    type = 'PV';
                    Pgen = parseFloat((Math.random() * 1.5 + 1.0).toFixed(3));
                    V_init = 1.05;
                }
                
                const loadMultiplier = 1 + (i / NUM_BUSES) * 0.5;
                const P_load_base = parseFloat(((Math.random() * 1.0 + 0.1) * loadMultiplier).toFixed(3));
                const Q_load_base = parseFloat(((Math.random() * 0.5 + 0.1) * loadMultiplier).toFixed(3));

                busData.push({
                    id: i,
                    type: type,
                    P_gen: Pgen,
                    Q_gen: 0.0,
                    P_load_base: P_load_base, 
                    Q_load_base: Q_load_base, 
                    P_load: P_load_base, 
                    Q_load: Q_load_base, 
                    V: V_init,
                    delta: 0.0,
                    V_result: V_init,
                    voltage_drop_percent: 0.0,
                    // Smart Grid Features:
                    DG_status: (i === 4 || i === 12) ? 'Off' : 'N/A', 
                    DG_capacity: (i === 4 || i === 12) ? 1.5 : 0.0,
                    DG_Q_mode: 'Unity', // Unity, Boost V, Absorb Q
                    DR_enabled: (i === 7 || i === 15) ? true : false, 
                    DR_reduction: 0.0 
                });
            }
            
            // 2. Define Bus Coordinates (SVG width 1000, height 400)
            const busCoordsMap = {
                1: { x: 50, y: 50 },    2: { x: 950, y: 50 },
                3: { x: 300, y: 150 },  4: { x: 700, y: 150 },
                5: { x: 100, y: 250 },  6: { x: 250, y: 300 },
                7: { x: 450, y: 200 },  8: { x: 550, y: 200 },
                9: { x: 750, y: 300 },  10: { x: 900, y: 250 },
                11: { x: 50, y: 350 },  12: { x: 200, y: 350 },
                13: { x: 400, y: 350 }, 14: { x: 600, y: 350 },
                15: { x: 800, y: 350 }
            };

            for (let i = 1; i <= NUM_BUSES; i++) {
                busCoordinates.push({ id: i, x: busCoordsMap[i].x, y: busCoordsMap[i].y });
            }

            // 3. Line/Branch Data Initialization
            const connections = [
                [1, 3], [2, 4], [3, 7], [4, 8], [7, 8], [8, 9], [7, 6], [9, 10], 
                [5, 11], [11, 12], [12, 6], [6, 5], [9, 14], [14, 15], [15, 10], [10, 9],
                [1, 5], [2, 10], [3, 6], [4, 9], [5, 12], [6, 13], [7, 14], [8, 15],
                [13, 14], [12, 13], [11, 12], [10, 15], [3, 13], [4, 14], [1, 11], [2, 15]
            ];
            
            connections.slice(0, NUM_LINES).forEach((conn, index) => {
                const [fromBus, toBus] = conn;
                const acsrType = ACSR_TYPES[Math.floor(Math.random() * ACSR_TYPES.length)];
                
                const Z_BASE_KV_LINE = (BASE_KV_LINE * BASE_KV_LINE) / BASE_MVA;
                const assumedLengthKm = 5;

                const R_pu = parseFloat((acsrType.R_DC * assumedLengthKm / Z_BASE_KV_LINE).toFixed(6));
                const X_pu = parseFloat((R_pu * acsrType.X_R_ratio).toFixed(6));

                lineData.push({
                    id: index + 1,
                    from: fromBus,
                    to: toBus,
                    R_pu: R_pu, 
                    X_pu: X_pu, 
                    R_user: R_pu,
                    X_user: X_pu,
                    Z_pu: Math.sqrt(R_pu * R_pu + X_pu * X_pu),
                    wireType: acsrType.code,
                    active: true,
                    // New protection data
                    breakerModel: BREAKER_MODELS[Math.floor(Math.random() * BREAKER_MODELS.length)],
                    recloserModel: RECLOSER_MODELS[Math.floor(Math.random() * RECLOSER_MODELS.length)],
                    isWireAdequate: true, // Reset on init
                    recommendedWire: null 
                });
            });

            // Display configuration panels
            displayLineConfiguration();
            displayBusEditing();
        }


        function recalculateLineImpedance(lineId, newWireType) {
            const line = lineData.find(l => l.id === lineId);
            const acsrType = ACSR_TYPES.find(t => t.code === newWireType);
            const Z_BASE = (BASE_KV_LINE * BASE_KV_LINE) / BASE_MVA;
            const assumedLengthKm = 5; 

            if (line && acsrType) {
                const R_pu = parseFloat((acsrType.R_DC * assumedLengthKm / Z_BASE).toFixed(6));
                const X_pu = parseFloat((R_pu * acsrType.X_R_ratio).toFixed(6));

                line.R_pu = R_pu;
                line.X_pu = X_pu;
                line.R_user = R_pu;
                line.X_user = X_pu;
                line.Z_pu = Math.sqrt(line.R_user * line.R_user + line.X_user * line.X_user);
                line.wireType = newWireType;
            }
        }


        function updateSystemParameter(id, key, value) {
            const numValue = parseFloat(value);
            
            if (key === 'P_gen' || key === 'V' || key === 'P_load_base' || key === 'Q_load_base' || key === 'DR_reduction') {
                const bus = busData.find(b => b.id === id);
                if (bus && !isNaN(numValue)) {
                    bus[key] = numValue;
                }
            } else if (key === 'DG_status' || key === 'DG_Q_mode') {
                 const bus = busData.find(b => b.id === id);
                 if (bus) {
                     bus[key] = value;
                 }
            } else {
                const line = lineData.find(l => l.id === id);
                if (!line) return;

                if (key === 'R_user' || key === 'X_user') {
                    if (!isNaN(numValue)) {
                        line[key] = numValue;
                        line.Z_pu = Math.sqrt(line.R_user * line.R_user + line.X_user * line.X_user);
                    }
                } else if (key === 'wireType') {
                    recalculateLineImpedance(id, value);
                    displayLineConfiguration(); 
                    displayNetworkTopology(lfResults);
                } else if (key === 'from' || key === 'to') {
                    const busId = parseInt(value);
                    if (busId >= 1 && busId <= NUM_BUSES) {
                        line[key] = busId;
                        displayNetworkTopology(lfResults);
                    }
                } else if (key === 'breakerModel' || key === 'recloserModel') {
                     line[key] = value;
                }
            }
        }

        /**
         * Populates the bus parameter editing panel with DG/DR controls.
         */
        function displayBusEditing() {
            const editDiv = document.getElementById('busParameterEditing');
            editDiv.innerHTML = '';
            
            const busInputs = busData.map(bus => {
                const isSlack = bus.type === 'Slack';
                
                let inputHTML = '';
                let busWrapperClasses = "bg-gray-50 p-3 rounded-xl border border-gray-200 space-y-2 shadow-sm"; 
                
                let loadFields = `
                    <div class="flex space-x-2">
                        <div class="flex-1 space-y-1">
                            <label class="block text-xs font-medium text-gray-600">P Load</label>
                            <input type="number" value="${bus.P_load_base.toFixed(3)}" step="0.01" min="0" 
                                class="w-full config-input text-sm" onchange="updateSystemParameter(${bus.id}, 'P_load_base', this.value)">
                        </div>
                        <div class="flex-1 space-y-1">
                            <label class="block text-xs font-medium text-gray-600">Q Load</label>
                            <input type="number" value="${bus.Q_load_base.toFixed(3)}" step="0.01" min="0"
                                class="w-full config-input text-sm" onchange="updateSystemParameter(${bus.id}, 'Q_load_base', this.value)">
                        </div>
                    </div>
                `;

                if (isSlack) {
                     inputHTML = `<label class="block text-xs font-bold text-text-dark">Bus ${bus.id} (Slack)</label><span class="text-xs text-gray-500 block text-center pt-2">V and &delta; are fixed.</span>`;
                     busWrapperClasses += " flex flex-col justify-center items-center h-full";
                } else {
                    let smartGridFields = '';
                    
                    if (bus.type === 'PV') {
                         loadFields = `
                            <div class="flex space-x-2">
                                <div class="flex-1 space-y-1">
                                    <label class="block text-xs font-medium text-gray-600">P Gen</label>
                                    <input type="number" value="${bus.P_gen.toFixed(3)}" step="0.01" min="0" 
                                        class="w-full config-input text-sm" onchange="updateSystemParameter(${bus.id}, 'P_gen', this.value)">
                                </div>
                                <div class="flex-1 space-y-1">
                                    <label class="block text-xs font-medium text-gray-600">V Set</label>
                                    <input type="number" value="${bus.V.toFixed(3)}" step="0.001" min="0.95" max="1.10"
                                        class="w-full config-input text-sm" onchange="updateSystemParameter(${bus.id}, 'V', this.value)">
                                </div>
                            </div>
                        `;
                    }
                    
                    // DG Control
                    if (bus.DG_capacity > 0) {
                        smartGridFields += `
                            <div class="space-y-1 pt-2 border-t border-gray-200">
                                <label class="block text-xs font-medium text-gray-600">DG Status (Cap: ${bus.DG_capacity} p.u.)</label>
                                <select class="line-select" onchange="updateSystemParameter(${bus.id}, 'DG_status', this.value)">
                                    <option value="On" ${bus.DG_status === 'On' ? 'selected' : ''}>ON</option>
                                    <option value="Off" ${bus.DG_status === 'Off' ? 'selected' : ''}>OFF</option>
                                </select>
                                <label class="block text-xs font-medium text-gray-600">Q Control</label>
                                <select class="line-select" onchange="updateSystemParameter(${bus.id}, 'DG_Q_mode', this.value)">
                                    <option value="Unity" ${bus.DG_Q_mode === 'Unity' ? 'selected' : ''}>Unity (PF=1)</option>
                                    <option value="Boost V" ${bus.DG_Q_mode === 'Boost V' ? 'selected' : ''}>Boost V (+Q)</option>
                                    <option value="Absorb Q" ${bus.DG_Q_mode === 'Absorb Q' ? 'selected' : ''}>Absorb Q (-Q)</option>
                                </select>
                            </div>
                        `;
                    }

                    // DR Control
                    if (bus.DR_enabled) {
                        smartGridFields += `
                            <div class="space-y-1 pt-2 ${bus.DG_capacity > 0 ? '' : 'border-t border-gray-200'}">
                                <label class="block text-xs font-medium text-gray-600">Demand Response (DR)</label>
                                <input type="number" value="${bus.DR_reduction.toFixed(3)}" step="0.01" min="0" max="${bus.P_load_base * 0.5}"
                                    class="w-full config-input text-sm" onchange="updateSystemParameter(${bus.id}, 'DR_reduction', this.value)" placeholder="P Reduction (p.u.)">
                            </div>
                        `;
                    }


                     inputHTML = `
                        <label class="block text-xs font-bold text-text-dark">Bus ${bus.id} (${bus.type})</label>
                        ${loadFields}
                        ${smartGridFields}
                    `;
                }
                return `<div class="${busWrapperClasses}">${inputHTML}</div>`;
            }).join('');

            editDiv.innerHTML = busInputs;
        }
        
        /**
         * Populates the line configuration panel with toggles and editable R/X inputs, plus protection.
         */
        function displayLineConfiguration() {
            const configDiv = document.getElementById('lineConfiguration');
            configDiv.innerHTML = '';
            document.getElementById('lineConfigHeader').classList.add('line-item-full'); // Update header grid

            const sortedACSRTypes = ACSR_TYPES.map(type => ({
                code: type.code,
                displayName: type.name
            })).sort((a, b) => a.displayName.localeCompare(b.displayName));
            
            const getBreakerSelect = (line) => `
                 <select class="line-select" onchange="updateSystemParameter(${line.id}, 'breakerModel', this.value)">
                    ${BREAKER_MODELS.map(model => 
                        `<option value="${model}" ${line.breakerModel === model ? 'selected' : ''}>${model}</option>`
                    ).join('')}
                </select>
            `;

            const getRecloserSelect = (line) => `
                 <select class="line-select" onchange="updateSystemParameter(${line.id}, 'recloserModel', this.value)">
                    ${RECLOSER_MODELS.map(model => 
                        `<option value="${model}" ${line.recloserModel === model ? 'selected' : ''}>${model}</option>`
                    ).join('')}
                </select>
            `;

            lineData.forEach(line => {
                const selectElement = `
                    <select class="line-select" onchange="updateSystemParameter(${line.id}, 'wireType', this.value)">
                        ${sortedACSRTypes.map(type => 
                            `<option value="${type.code}" ${line.wireType === type.code ? 'selected' : ''}>${type.displayName}</option>`
                        ).join('')}
                    </select>
                `;

                configDiv.innerHTML += `
                    <div class="line-item-full">
                        ${selectElement}

                        <input type="number" value="${line.from}" min="1" max="${NUM_BUSES}" 
                            class="config-input text-center text-sm" 
                            onchange="updateSystemParameter(${line.id}, 'from', this.value)" title="From Bus">
                        
                        <input type="number" value="${line.to}" min="1" max="${NUM_BUSES}" 
                            class="config-input text-center text-sm" 
                            onchange="updateSystemParameter(${line.id}, 'to', this.value)" title="To Bus">
                        
                        <input type="number" value="${line.R_user.toFixed(4)}" step="0.0001" min="0" 
                            class="config-input text-right" 
                            onchange="updateSystemParameter(${line.id}, 'R_user', this.value)" title="Resistance (p.u.)">
                        
                        <input type="number" value="${line.X_user.toFixed(4)}" step="0.0001" min="0" 
                            class="config-input text-right" 
                            onchange="updateSystemParameter(${line.id}, 'X_user', this.value)" title="Reactance (p.u.)">
                        
                        ${getBreakerSelect(line)}
                        ${getRecloserSelect(line)}
                        
                        <label class="relative inline-flex items-center cursor-pointer justify-center">
                            <input type="checkbox" ${line.active ? 'checked' : ''} class="sr-only peer" 
                                   onchange="toggleLineActive(${line.id}, this.checked); displayNetworkTopology(lfResults);">
                            <div class="w-7 h-4 bg-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    </div>
                `;
            });
        }

        // --- Existing UI Display Functions ---

        function displayLoadFlowResults(results, method) {
            const table = document.getElementById('lfTable');
            const lfMessage = document.getElementById('lfMessage');
            let tableHTML = `
                <thead>
                    <tr>
                        <th class="rounded-tl-lg">Bus ID</th>
                        <th>Type</th>
                        <th>V Mag. (p.u.)</th>
                        <th>V Drop (%)</th>
                        <th>P Load (p.u.)</th>
                        <th>P Gen (p.u.)</th>
                        <th class="rounded-tr-lg">Q Gen/Mode</th>
                    </tr>
                </thead>
                <tbody>
            `;

            results.forEach(res => {
                const bus = busData.find(b => b.id === res.id);
                let colorClass = 'text-code-pass';
                let voltageWarning = '';

                if (res.V < 0.97) { colorClass = 'text-yellow-600 font-semibold'; voltageWarning = ' (Low V)'; }
                if (res.V < 0.93) { colorClass = 'text-red-600 font-bold'; voltageWarning = ' (CRITICAL)'; }
                if (res.V > 1.04) { colorClass = 'text-primary font-semibold'; voltageWarning = ' (High V)'; }
                
                const isVDOK = res.voltage_drop_percent <= MAX_VOLTAGE_DROP_PERCENT;
                const vdColorClass = isVDOK ? 'text-code-pass' : 'text-code-fail font-bold';

                const Q_gen_text = bus.DG_capacity > 0 && bus.DG_status === 'On' ? 
                                   `${bus.Q_gen.toFixed(3)} (${bus.DG_Q_mode})` : 
                                   (bus.type === 'Slack' ? 'Ref' : bus.Q_gen.toFixed(3));
                
                tableHTML += `
                    <tr>
                        <td>${bus.id}</td>
                        <td>${bus.type}</td>
                        <td class="${colorClass}">${res.V.toFixed(4)} ${voltageWarning}</td>
                        <td class="${vdColorClass}">${res.voltage_drop_percent.toFixed(2)}%</td>
                        <td>${bus.P_load.toFixed(3)} (DR: ${bus.DR_reduction.toFixed(3)})</td>
                        <td>${bus.P_gen.toFixed(3)} ${bus.DG_capacity > 0 ? (bus.DG_status === 'On' ? '(DG ON)' : '(N/A)') : ''}</td>
                        <td>${Q_gen_text}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody>`;
            
            if (table) {
                table.innerHTML = tableHTML;
                table.classList.remove('hidden');
            }

            if (lfMessage) {
                lfMessage.innerHTML = `<p class="text-sm text-center text-primary mb-2 font-medium">Load Flow completed using **${method}** method simulation. ${lineData.filter(l => l.active).length}/${NUM_LINES} wires active.</p>`;
                lfMessage.classList.add('hidden'); // Hide message when table is visible
            }
        }
        
        function displayIterativeResults() { 
            const iterativeDiv = document.getElementById('loadFlowIterativeResults');
            const messageDiv = document.getElementById('lfIterativeMessage');
            
            if (lfIterativeData.length === 0) {
                 messageDiv.innerHTML = `<p class="text-gray-500 text-center py-10">The step-by-step convergence data will appear here after running the Load Flow Analysis.</p>`;
                 return;
            }

            const method = lfIterativeData[0].method;
            let htmlContent = `<h3 class="text-lg font-semibold text-text-dark mb-3 text-center">Simulated ${method} Iterations for Convergence (V and &delta;)</h3>`;

            // Loop through each bus to create its own table/section
            for (let i = 1; i <= NUM_BUSES; i++) {
                const busId = i;
                const busType = busData.find(b => b.id === busId).type;

                htmlContent += `
                    <div class="mb-6 border p-3 rounded-lg bg-gray-50">
                        <h4 class="font-bold text-md text-text-dark mb-2">Bus ${busId} (${busType})</h4>
                        <table class="w-full iterative-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Iteration (k)</th>
                                    <th colspan="2">Voltage (V)</th>
                                    <th colspan="2">Angle (&delta;) (Deg)</th>
                                </tr>
                                <tr>
                                    <th>Magnitude (p.u.)</th>
                                    <th>Change (&Delta;V)</th>
                                    <th>Value</th>
                                    <th>Change (&Delta;&delta;)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Loop through iterations for this specific bus
                for (let k = 0; k < lfIterativeData.length; k++) {
                    const currentData = lfIterativeData[k].data.find(d => d.id === busId);
                    const prevData = (k > 0) ? lfIterativeData[k-1].data.find(d => d.id === busId) : currentData;

                    const V_mag = currentData.V.toFixed(4);
                    const delta_val = currentData.delta.toFixed(4);
                    
                    const deltaV = (k > 0) ? (currentData.V - prevData.V).toFixed(4) : '-';
                    const deltaDelta = (k > 0) ? (currentData.delta - prevData.delta).toFixed(4) : '-';

                    htmlContent += `
                        <tr>
                            <td>${k}</td>
                            <td>${V_mag}</td>
                            <td class="${k > 0 && Math.abs(deltaV) > 0.001 ? 'text-red-500' : 'text-gray-500'}">${deltaV}</td>
                            <td>${delta_val}</td>
                            <td class="${k > 0 && Math.abs(deltaDelta) > 0.001 ? 'text-red-500' : 'text-gray-500'}">${deltaDelta}</td>
                        </tr>
                    `;
                }
                
                htmlContent += `</tbody></table></div>`;
            }

            messageDiv.innerHTML = htmlContent;
        }

        function displayShortCircuitResults(results) {
            const scBody = document.getElementById('scBody');
            
            const faultNames = {
                'LLL': 'Three-Phase Bolted Fault (L-L-L)',
                'SLG': 'Single-Line-to-Ground Fault (L-G)',
                'LL': 'Line-to-Line Fault (L-L)',
                'LLG': 'Double-Line-to-Ground Fault (L-L-G)'
            };

            scBody.innerHTML = `
                <tr><td>Faulted Bus ID</td><td>${results.busId}</td></tr>
                <tr><td>Fault Type</td><td>${faultNames[results.faultType]}</td></tr>
                <tr><td>Pre-Fault Voltage (V<sub class="text-xs">f</sub>)</td><td>${lfResults ? lfResults.find(r => r.id === results.busId).V.toFixed(4) : 'N/A'} p.u.</td></tr>
                
                <tr class="bg-gray-100"><td colspan="2" class="font-bold text-center">Sequence Impedances (p.u.) (Simulated)</td></tr>
                <tr><td>Positive Sequence (Z<sub class="text-xs">1</sub>)</td><td>Simulated: Variable</td></tr>
                <tr><td>Negative Sequence (Z<sub class="text-xs">2</sub>)</td><td>Simulated: Variable</td></tr>
                <tr><td>Zero Sequence (Z<sub class="text-xs">0</sub>)</td><td>Simulated: Variable</td></tr>

                <tr class="bg-gray-100"><td colspan="2" class="font-bold text-center">Sequence Currents (I) (p.u.) (Simulated)</td></tr>
                <tr><td>Positive Sequence (I<sub class="text-xs">1</sub>)</td><td>Simulated: Variable</td></tr>
                <tr><td>Negative Sequence (I<sub class="text-xs">2</sub>)</td><td>Simulated: Variable</td></tr>
                <tr><td>Zero Sequence (I<sub class="text-xs">0</sub>)</td><td>Simulated: Variable</td></tr>
                
                <tr class="bg-gray-100"><td colspan="2" class="font-bold text-center">Fault Results</td></tr>
                <tr><td>**Fault Current (Amperes)**</td><td class="text-secondary">${results.I_fault_A}</td></tr>
                <tr><td>**Short Circuit MVA (MVA<sub class="text-xs">sc</sub>)**</td><td class="text-secondary">${results.MVA_sc}</td></tr>
            `;

             document.getElementById('shortCircuitResults').insertAdjacentHTML('afterbegin', `<p class="text-sm text-center text-primary mb-2 font-medium">
                Short Circuit analysis completed for a bolted **${results.faultType}** fault at Bus ${results.busId}.
             </p>`);
        }
        
        function displayNetworkTopology(results = null) {
            const svg = document.getElementById('networkSVG');
            if (!svg) return; 
            
            const svgWidth = svg.clientWidth || 1000;
            const svgHeight = svg.clientHeight || 400;
            svg.setAttribute('viewBox', `0 0 1000 400`);
            svg.innerHTML = ''; 

            // 1. Draw Lines (Wires)
            lineData.forEach(line => {
                const fromCoords = busCoordinates.find(b => b.id === line.from);
                const toCoords = busCoordinates.find(b => b.id === line.to);

                if (!fromCoords || !toCoords) return; 

                let lineStroke = line.active ? '#374151' : '#d1d5db'; 
                let lineDash = line.active ? 'none' : '4';
                let lineOpacity = line.active ? 1.0 : 0.5;

                svg.innerHTML += `
                    <line x1="${fromCoords.x}" y1="${fromCoords.y}" x2="${toCoords.x}" y2="${toCoords.y}"
                          stroke="${lineStroke}" stroke-width="2" stroke-dasharray="${lineDash}" opacity="${lineOpacity}" 
                          title="Line ${line.id}: ${line.from}-${line.to} (${line.wireType})" />
                `;
            });

            // 2. Draw Buses (Nodes)
            busCoordinates.forEach(bus => {
                let V_text = busData.find(b => b.id === bus.id)?.V_result.toFixed(3) || '1.000';
                let color = 'var(--tw-colors-bus-default)'; 

                if (results) {
                    const res = results.find(r => r.id === bus.id);
                    if (res) {
                        if (res.V < 0.97) color = 'var(--tw-colors-bus-low)'; 
                        else if (res.V < 0.93) color = 'var(--tw-colors-bus-crit)'; 
                        else color = 'var(--tw-colors-bus-good)'; 
                    }
                }
                
                if (bus.id === selectedFaultBus) {
                    color = 'var(--tw-colors-bus-fault)';
                }

                // Node circle
                svg.innerHTML += `
                    <circle cx="${bus.x}" cy="${bus.y}" r="12" fill="${color}" stroke="#1f2937" stroke-width="1.5"
                            cursor="pointer" onclick="selectFaultBus(${bus.id})"
                            title="Bus ${bus.id}: V=${V_text} p.u." />
                `;
                // Node text (Bus ID)
                svg.innerHTML += `
                    <text x="${bus.x}" y="${bus.y + 3}" text-anchor="middle" fill="white" font-size="10px" font-weight="bold"
                          cursor="pointer" onclick="selectFaultBus(${bus.id})">
                        ${bus.id}
                    </text>
                `;
                // Voltage text label
                svg.innerHTML += `
                    <text x="${bus.x}" y="${bus.y + 25}" text-anchor="middle" fill="${color}" font-size="10px">
                        ${V_text} p.u.
                    </text>
                `;
            });
        }
        
        function toggleLineActive(lineId, isActive) {
            const line = lineData.find(l => l.id === lineId);
            if (line) {
                line.active = isActive;
            }
        }

        function selectFaultBus(busId) {
            if (busId >= 1 && busId <= 15) {
                selectedFaultBus = busId;
                document.getElementById('faultBus').value = busId;
                document.getElementById('currentFaultBus').textContent = busId;
                displayNetworkTopology(lfResults);
            }
        }

        function showResults(view) {
            const views = {
                'loadFlow': document.getElementById('loadFlowResults'),
                'loadFlowIterative': document.getElementById('loadFlowIterativeResults'),
                'shortCircuit': document.getElementById('shortCircuitResults'),
                'compliance': document.getElementById('complianceResults')
            };
            const tabs = {
                'loadFlow': document.getElementById('tabLF'),
                'loadFlowIterative': document.getElementById('tabLFIterative'),
                'shortCircuit': document.getElementById('tabSC'),
                'compliance': document.getElementById('tabCompliance')
            };

            for (let v in views) {
                if (v === view) {
                    views[v].classList.remove('hidden');
                    tabs[v].classList.add('border-primary', 'text-primary');
                    tabs[v].classList.remove('border-transparent', 'text-gray-500');
                } else {
                    views[v].classList.add('hidden');
                    tabs[v].classList.remove('border-primary', 'text-primary');
                    tabs[v].classList.add('border-transparent', 'text-gray-500');
                }
            }
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeSystemData();
            selectFaultBus(10);
            displayNetworkTopology();
        });
    </script>
</body>
</html>
